---
# Main task file for dnsmasq role
- name: install dnsmasq
  package:
    name: dnsmasq
    state: latest
  tags:
    - dnsmasq
    - dnsmasq-install

- name: modify dnsmasq conf file
  template:
    src: etc/dnsmasq.conf.j2
    dest: /etc/dnsmasq.conf
    owner: root
    group: root
    mode: 0644
    validate: 'dnsmasq --test -C %s'
  notify: restart dnsmasq
  tags:
    - dnsmasq
    - dnsmasq-conf

- name: start and enable dnsmasq service
  service:
    name: dnsmasq
    state: started
    enabled: true
  tags:
      - dnsmasq
      - dnsmasq-start-and-enable-service

# Ubuntu/Debian installations override the /etc/resolv.conf file to
# replace the dns server with 127.0.0.1, but CentOS and AWS linux
# installations do not.  If we're not running on Debian, update the
# dhclient.conf file to add 127.0.0.1 as the first dns server entry
# in resolv.conf and restart networking services.
- include: dhclient.yml
  when: not ansible_os_family == 'Debian'


# On installations that use systemd-resolved, we need to add a file
# to /etc/systemd/resolved.conf.d
- name: check if the systemd-resolved service exists
  shell: service systemd-resolved status
  register: systemd_resolved_status
  failed_when: not(systemd_resolved_status.rc == 3 or systemd_resolved_status.rc == 0)
  tags:
    - dnsmasq
    - dnsmasq-start-and-enable-service

- name: ensure that the systemd-resolved custom config file exists
  copy:
    dest: /etc/systemd/resolved.conf.d/dnsmasq.conf
    content: "[Resolve]\nDNS={{ dnsmasq_listen_address }}\n"
  when: systemd_resolved_status.rc == 0
  notify: restart systemd-resolved
  tags:
    - dnsmasq
    - dnsmasq-start-and-enable-service